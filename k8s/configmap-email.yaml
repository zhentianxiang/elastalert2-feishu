apiVersion: v1
kind: ConfigMap
metadata:
  name: elastalert-config
  namespace: kube-logging
data:
  k8s_app_error.yaml: |
    es_host: elasticsearch  # Elasticsearch è¿æ¥åœ°å€
    es_port: 9200           # Elasticsearch ç«¯å£
    name: k8s_error_log_k8s     # è§„åˆ™åç§°ï¼Œç”¨äºæ ‡è¯†è§„åˆ™
    type: frequency         # è§„åˆ™ç±»å‹ï¼Œfrequency è¡¨ç¤ºåŸºäºæ—¥å¿—çš„é¢‘ç‡è¿›è¡Œå‘Šè­¦,æœ‰å¤šç§ç±»å‹,ä¸åŒçš„ç±»å‹é…ç½®é¡¹æœ‰ä¸åŒ
    query_key:              # ä¸è¿›è¡Œé‡å¤æé†’çš„å­—æ®µ
      - "message"           # ä½¿ç”¨ message å­—æ®µè¿›è¡Œåˆ¤æ–­
    #aggregation:            # èšåˆ 5 åˆ†é’Ÿå†…çš„ç»“æœï¼Œåˆå¹¶åœ¨ä¸€èµ·å‘é€
      #minutes: 5
    realert:                # åŒä¸€è§„åˆ™çš„ä¸¤æ¬¡è­¦æŠ¥ä¹‹é—´çš„æœ€çŸ­æ—¶é—´
      minutes: 1            # æœ€çŸ­æ—¶é—´é—´éš”ï¼Œæ§åˆ¶åŒä¸€è§„åˆ™çš„é‡å¤å‘Šè­¦é—´éš”
    exponential_realert:    # æŒ‡æ•°å‹æ‰©å±• realert æ—¶é—´ï¼Œä¾‹å¦‚ç¬¬ä¸€æ¬¡æ˜¯ 5 åˆ†é’Ÿï¼Œç¬¬äºŒæ¬¡æ˜¯ 10 åˆ†é’Ÿï¼Œä»¥æ­¤ç±»æ¨
      hours: 1    
    index: k8s-app-log-simulator-*            # åŒ¹é…ç´¢å¼•ï¼Œæ”¯æŒæ­£åˆ™
    num_events: 1           # ä¸è§„åˆ™åŒ¹é…çš„æ—¥å¿—å‡ºç°æ¬¡æ•°
    timeframe:              # åœ¨è¿™ä¸ªæ—¶é—´æ®µå†…ï¼Œå¦‚æœå‡ºç°æŒ‡å®šæ¬¡æ•°çš„æ—¥å¿—ï¼Œå°†è§¦å‘å‘Šè­¦
      minutes: 1
    aggregation_key: name     # æ ¹æ®æŠ¥è­¦çš„åç§°ï¼Œå°†ç›¸åŒçš„æŠ¥è­¦æŒ‰ç…§nameæ¥èšåˆ
    filter:
      - query:
          bool:
            must:
              - bool:
                  should:  # åŒ¹é…ä»»æ„ä¸€ä¸ªæ ‡ç­¾ï¼ˆOR å…³ç³»ï¼‰
                    - term: { kubernetes_labels_k8s-app.keyword: "nginx" }
                    - term: { kubernetes_labels_k8s-app.keyword: "log-simulator" }
                    - term: { kubernetes_labels_k8s-app.keyword: "your-app-1" }  # æ›¿æ¢ä¸ºæ‚¨çš„å…¶ä»–æ ‡ç­¾
                    - term: { kubernetes_labels_k8s-app.keyword: "your-app-2" }  # æ›¿æ¢ä¸ºæ‚¨çš„å…¶ä»–æ ‡ç­¾
                  minimum_should_match: 1  # è‡³å°‘åŒ¹é…ä¸€ä¸ªæ ‡ç­¾
              - query_string:  # ä¿ç•™åŸæœ‰çš„é”™è¯¯æ—¥å¿—åŒ¹é…
                  query: "message:(*error* OR *Exception* OR *stacktrace*)"
                  analyze_wildcard: true
            must_not:
              - query_string:
                  query: 'message: "INFO"'  # æ’é™¤åŒ…å« INFO çš„æ—¥å¿—
                  #query: 'uri:\/monitor\/getExceptionStatusList'   # è¿™é‡Œæ’é™¤äº†è¿™ä¸ªæ¥å£ï¼Œä½¿ç”¨äº†\è¿›è¡Œè½¬ä¹‰
                  analyze_wildcard: true
    alert:
    - "email"   # ä½¿ç”¨é‚®ä»¶æ¨¡å—
    - "elastalert.alerters.feishu.FeishuAlert"  # ä½¿ç”¨é£ä¹¦å‘Šè­¦æ¨¡å—

    # è¿™ä¸ªæ—¶é—´æ®µå†…çš„åŒ¹é…å°†ä¸å‘Šè­¦ï¼Œé€‚ç”¨äºæŸäº›æ—¶é—´æ®µè¯·æ±‚ä½è°·é¿å…è¯¯æŠ¥è­¦
    #feishualert_skip:
    #  start: "01:00:00"
    #  end: "08:00:00"

    email:
    - "2099637909@qq.com"
    smtp_host: smtp.qq.com
    smtp_port: 25
    smtp_auth_file: /opt/elastalert/smtp_auth.yaml      
    from_addr: 2099637909@qq.com

    email_format: html
    alert_text_type: alert_text_only
    # æ ‡é¢˜
    alert_subject: "ç”Ÿäº§ç¯å¢ƒæ—¥å¿—å‘Šè­¦é€šçŸ¥"
    # ä¸°å¯Œçš„é‚®ä»¶æ¨¡æ¿ï¼ŒåŒ…å«äº†æ›´å¤šè¯¦ç»†çš„å­—æ®µ
    alert_text: "<br><a href='http://k8s-kibana.localhost.com/app/kibana' target='_blank' style='padding: 8px 16px;background-color: #46bc99;text-decoration:none;color:white;border-radius: 5px;'>ç«‹åˆ»å‰å¾€KibanaæŸ¥çœ‹</a><br>
    <table>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>å‘Šè­¦æ—¶é—´</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{@timestamp}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>æœåŠ¡åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{module}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>æ—¥å¿—çº§åˆ«</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{level}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>é”™è¯¯æ—¥å¿—</td>
    <td style='padding:10px 5px;border-radius: 5px;background-color: #F8F9FA;'>{msg}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>é”™è¯¯æ•°é‡</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{num_hits}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>åŒ¹é…æ—¥å¿—æ•°é‡</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{num_matches}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>ä¸»æœºå</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{host}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>Pod åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{kubernetes.pod_name}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>å®¹å™¨åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{kubernetes.container_name}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>å®¹å™¨ID</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{kubernetes.container_id}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>æ—¥å¿—æµ</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{stream}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>ç´¢å¼•åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{_index}</td></tr>
    </table>"



    feishu_webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-e043-4a64-975d-xxxxxxxx"
    feishu_alert_type: "card"            # é»˜è®¤å°±æ˜¯ card
    alert_text_args:
    - "@timestamp"                       # å‘Šè­¦è§¦å‘æ—¶é—´
    - "message"                          # é”™è¯¯æ—¥å¿—
    - "num_hits"                         # é”™è¯¯æ•°é‡
    - "num_matches"                      # è§„åˆ™å‘½ä¸­æ•°
    - "kubernetes_host"                  # ä¸»æœºå
    - "kubernetes_namespace_name"        # Kubernetes å‘½åç©ºé—´
    - "kubernetes_pod_name"              # Kubernetes Pod åç§°
    - "kubernetes_container_image"       # å®¹å™¨é•œåƒ
    - "kubernetes_container_name"        # å®¹å™¨åç§°
    - "stream"                           # æ—¥å¿—æµ
    - "_index"                           # ç´¢å¼•åç§°

    kibana_base_url: "http://k8s-kibana.linuxtian.com/app/kibana"

    feishu_card_template:
      msg_type: interactive
      card:
        header:
          title:
            tag: plain_text
            content: "ğŸš¨ k8sä¸šåŠ¡errorå¼‚å¸¸å‘Šè­¦"
          template: red
        elements:
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ•’ è§¦å‘æ—¶é—´ï¼š**{{@timestamp_local}}" # æœ¬åœ°æ—¶é—´ UTC+8
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“¦ å‘½åç©ºé—´ï¼š**{{kubernetes_namespace_name}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ³ Pod åç§°ï¼š**{{kubernetes_pod_name}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ§ª å®¹å™¨é•œåƒï¼š**{{kubernetes_container_image}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“› å®¹å™¨åç§°ï¼š**{{kubernetes_container_name}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“ˆ æ—¥å¿—æµï¼š**{{stream}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ—‚ ç´¢å¼•åç§°ï¼š**{{_index}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“Š é”™è¯¯æ•°é‡ï¼š**{{num_hits}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ¯ è§„åˆ™å‘½ä¸­æ•°ï¼š**{{num_matches}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“ é”™è¯¯æ—¥å¿—ï¼š**{{message}}"
          - tag: hr
          - tag: action
            actions:
              - tag: button
                text:
                  tag: plain_text
                  content: "ğŸ” æŸ¥çœ‹ Kibana æ—¥å¿—"
                type: default
                url: "{{ kibana_url }}"

  config.json: |
    {
      "appName": "elastalert-server",
      "port": 3030,                
      "wsport": 3333,
      "elastalertPath": "/opt/elastalert",
      "verbose": false,
      "es_debug": false,
      "debug": false,
      "rulesPath": {
        "relative": true,
        "path": "/rules"
      },
      "templatesPath": {
        "relative": true,
        "path": "/rule_templates"
      },
      "es_host": "elasticsearch",
      "es_port": 9200,
      "writeback_index": "elastalert_status"
    }
  # ElastAlertä¸»é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†è§„åˆ™ç›®å½•ã€æ‰§è¡Œé¢‘ç‡ç­‰å…¨å±€è®¾ç½®
  elastalert.yaml: |
    rules_folder: rules               # è§„åˆ™ç›®å½•
    run_every:
      seconds: 60                     # æ¯ 60 ç§’æ£€æŸ¥ä¸€æ¬¡è§„åˆ™
    buffer_time:
      minutes: 5                      # ç¼“å†²æ—¶é—´ä¸º 5 åˆ†é’Ÿ
    max_running_instances: 5          # å…è®¸æœ€å¤šå¹¶å‘ 5 ä¸ªè§„åˆ™æ‰§è¡Œ
    es_host: elasticsearch            # Elasticsearch ä¸»æœº
    es_port: 9200                     # Elasticsearch ç«¯å£
    use_ssl: False                    # æ˜¯å¦ä½¿ç”¨ SSL åŠ å¯†
    verify_certs: False               # æ˜¯å¦éªŒè¯ SSL è¯ä¹¦
    writeback_index: elastalert_status_k8s  # ç”¨äºå†™å›å‘Šè­¦çŠ¶æ€çš„ç´¢å¼•
    writeback_alias: elastalert_alerts_k8s  # ç”¨äºå†™å›å‘Šè­¦çš„åˆ«å
    alert_time_limit:
      days: 2                         # è®°å½•å‘Šè­¦çš„æœ€å¤§æ—¶é—´èŒƒå›´ï¼Œè¶…è¿‡2å¤©çš„å‘Šè­¦ä¼šè¢«æ¸…é™¤
