apiVersion: v1
kind: ConfigMap
metadata:
  name: elastalert-config
  namespace: kube-logging
data:
  k8s_app_error.yaml: |
    # ========== åŸºç¡€é…ç½® ==========
    es_host: elasticsearch       # ElasticsearchæœåŠ¡åœ°å€ï¼ˆKubernetesæœåŠ¡åæˆ–IPï¼‰
    es_port: 9200                # ElasticsearchæœåŠ¡ç«¯å£

    # ========== è§„åˆ™æ ¸å¿ƒé…ç½® ==========
    name: k8s_error_log_helloworld  # è§„åˆ™å”¯ä¸€æ ‡è¯†åç§°ï¼ˆç”¨äºæ—¥å¿—å’Œå‘Šè­¦åŒºåˆ†ï¼‰
    type: frequency              # è§„åˆ™ç±»å‹ï¼š
                                #   - frequency: é¢‘ç‡å‹ï¼ˆå›ºå®šæ—¶é—´æ®µå†…è¾¾åˆ°é˜ˆå€¼è§¦å‘ï¼‰
                                #   - any: åŒ¹é…åˆ°å³è§¦å‘
                                #   - spike: æµé‡çªå¢/çªé™
                                #   - flatline: æµé‡ä½äºé˜ˆå€¼
                                #   - change: å­—æ®µå€¼å˜åŒ–æ—¶è§¦å‘

    # ========== äº‹ä»¶å»é‡é…ç½® ==========
    query_key:                   # å®šä¹‰å»é‡å­—æ®µï¼ˆç›¸åŒå€¼çš„æ—¥å¿—è§†ä¸ºé‡å¤ï¼‰
      - "@timestamp"             # æ—¶é—´æˆ³å­—æ®µï¼ˆå…¶æ„æ€è¡¨ç¤ºä¸ºç”¨æ—¶é—´å»åˆ¤æ–­äº¦æˆ–è€…ç†è§£ä¸ºä¸å»é‡ï¼Œå› ä¸ºæ—¶é—´æ²¡æœ‰é‡å¤çš„ï¼‰
      - "message"                # æ—¥å¿—å†…å®¹å­—æ®µï¼ˆç›¸åŒmessageè§†ä¸ºé‡å¤äº‹ä»¶ï¼‰

    realert:                     # ç›¸åŒå‘Šè­¦çš„æœ€å°é—´éš”æ—¶é—´ï¼ˆé˜²éªšæ‰°ï¼‰
      minutes: 0                 # 0è¡¨ç¤ºæ¯æ¬¡åŒ¹é…éƒ½å‘Šè­¦ï¼ˆé€‚åˆå…³é”®é”™è¯¯ï¼‰
                                # è‹¥è®¾ä¸º5ï¼Œåˆ™5åˆ†é’Ÿå†…ç›¸åŒé”™è¯¯åªå‘Šè­¦ä¸€æ¬¡

    # ========== å‘Šè­¦è§¦å‘æ¡ä»¶ ==========
    index: k8s-app-*  # ç›‘æ§çš„ç´¢å¼•æ¨¡å¼ï¼ˆæ”¯æŒé€šé…ç¬¦å’Œæ—¥æœŸæ¨¡å¼ï¼‰
    num_events: 1                # è§¦å‘é˜ˆå€¼ï¼ˆ1è¡¨ç¤ºåŒ¹é…åˆ°1æ¡å³å‘Šè­¦ï¼‰
    timeframe:                   # ç»Ÿè®¡æ—¶é—´çª—å£ï¼ˆä¸num_eventsé…åˆä½¿ç”¨ï¼‰
      minutes: 1                 # åœ¨1åˆ†é’Ÿå†…å‡ºç°num_eventsæ¬¡åˆ™è§¦å‘

    # ========== é«˜çº§é…ç½®ï¼ˆç¤ºä¾‹ï¼‰ ==========
    # aggregation:               # å‘Šè­¦èšåˆé…ç½®ï¼ˆå°†å¤šæ¡æ—¥å¿—åˆå¹¶ä¸ºä¸€ä¸ªå‘Šè­¦ï¼‰
    #   minutes: 5               # 5åˆ†é’Ÿå†…çš„åŒ¹é…æ—¥å¿—åˆå¹¶å‘é€
    #   summary_table_fields:    # èšåˆå‘Šè­¦ä¸­æ˜¾ç¤ºçš„å­—æ®µ
    #     - "message"

    # exponential_realert:        # æŒ‡æ•°çº§å‘Šè­¦é—´éš”ï¼ˆç”¨äºé€æ¸é™ä½é¢‘ç¹é”™è¯¯é€šçŸ¥ï¼‰
    #   hours: 1                 # æ¯æ¬¡é‡å¤å‘Šè­¦é—´éš”ä¹˜ä»¥2ï¼ˆ1hâ†’2hâ†’4h...ï¼‰
    filter:
      - query:
          bool:
            must:
              - bool:
                  should:  # åŒ¹é…ä»»æ„ä¸€ä¸ªæ ‡ç­¾ï¼ˆOR å…³ç³»ï¼‰
                    - term: { kubernetes_labels_k8s-app.keyword: "nginx" }
                    - term: { kubernetes_labels_k8s-app.keyword: "log-simulator" }
                    - term: { kubernetes_labels_k8s-app.keyword: "your-app-1" }  # æ›¿æ¢ä¸ºæ‚¨çš„å…¶ä»–æ ‡ç­¾
                    - term: { kubernetes_labels_k8s-app.keyword: "your-app-2" }  # æ›¿æ¢ä¸ºæ‚¨çš„å…¶ä»–æ ‡ç­¾
                  minimum_should_match: 1  # è‡³å°‘åŒ¹é…ä¸€ä¸ªæ ‡ç­¾
              - query_string:  # å¿…é¡»æ˜¯ ERROR ç­‰çº§
                  query: 'message: "*ERROR*" OR message: "*Exception*" OR message: "*stacktrace*"'
                  analyze_wildcard: true
            must_not:
              - query_string:
                  query: 'message: "*INFO*"'  # æ’é™¤åŒ…å« INFO çš„æ—¥å¿—
                  #query: 'uri:\/monitor\/getExceptionStatusList'   # è¿™é‡Œæ’é™¤äº†è¿™ä¸ªæ¥å£ï¼Œä½¿ç”¨äº†\è¿›è¡Œè½¬ä¹‰
                  analyze_wildcard: true
    alert:
    - "email"   # ä½¿ç”¨é‚®ä»¶æ¨¡å—
    - "elastalert.alerters.feishu.FeishuAlert"  # ä½¿ç”¨é£ä¹¦å‘Šè­¦æ¨¡å—

    # è¿™ä¸ªæ—¶é—´æ®µå†…çš„åŒ¹é…å°†ä¸å‘Šè­¦ï¼Œé€‚ç”¨äºæŸäº›æ—¶é—´æ®µè¯·æ±‚ä½è°·é¿å…è¯¯æŠ¥è­¦
    #feishualert_skip:
    #  start: "01:00:00"
    #  end: "08:00:00"

    email:
    - "2099637909@qq.com"
    smtp_host: smtp.qq.com
    smtp_port: 25
    smtp_auth_file: /opt/elastalert/smtp_auth.yaml      
    from_addr: 2099637909@qq.com

    email_format: html
    alert_text_type: alert_text_only
    # æ ‡é¢˜
    alert_subject: "ç”Ÿäº§ç¯å¢ƒæ—¥å¿—å‘Šè­¦é€šçŸ¥"
    # ä¸°å¯Œçš„é‚®ä»¶æ¨¡æ¿ï¼ŒåŒ…å«äº†æ›´å¤šè¯¦ç»†çš„å­—æ®µ
    alert_text: "<br><a href='http://k8s-kibana.localhost.com/app/kibana' target='_blank' style='padding: 8px 16px;background-color: #46bc99;text-decoration:none;color:white;border-radius: 5px;'>ç«‹åˆ»å‰å¾€KibanaæŸ¥çœ‹</a><br>
    <table>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>å‘Šè­¦æ—¶é—´</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{@timestamp}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>æœåŠ¡åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{module}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>æ—¥å¿—çº§åˆ«</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{level}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>é”™è¯¯æ—¥å¿—</td>
    <td style='padding:10px 5px;border-radius: 5px;background-color: #F8F9FA;'>{msg}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>é”™è¯¯æ•°é‡</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{num_hits}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>åŒ¹é…æ—¥å¿—æ•°é‡</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{num_matches}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>ä¸»æœºå</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{host}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>Pod åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{kubernetes.pod_name}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>å®¹å™¨åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{kubernetes.container_name}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>å®¹å™¨ID</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{kubernetes.container_id}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>æ—¥å¿—æµ</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{stream}</td></tr>
    <tr><td style='padding:5px;text-align: right;font-weight: bold;border-radius: 5px;background-color: #eef;'>ç´¢å¼•åç§°</td>
    <td style='padding:5px;border-radius: 5px;background-color: #eef;'>{_index}</td></tr>
    </table>"



    feishu_webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-e043-4a64-975d-xxxxxxxx"
    feishu_alert_type: "card"            # é»˜è®¤å°±æ˜¯ card
    alert_text_args:
    - "@timestamp"                       # å‘Šè­¦è§¦å‘æ—¶é—´
    - "message"                          # é”™è¯¯æ—¥å¿—
    - "num_hits"                         # é”™è¯¯æ•°é‡
    - "num_matches"                      # è§„åˆ™å‘½ä¸­æ•°
    - "kubernetes_host"                  # ä¸»æœºå
    - "kubernetes_namespace_name"        # Kubernetes å‘½åç©ºé—´
    - "kubernetes_pod_name"              # Kubernetes Pod åç§°
    - "kubernetes_container_image"       # å®¹å™¨é•œåƒ
    - "kubernetes_container_name"        # å®¹å™¨åç§°
    - "stream"                           # æ—¥å¿—æµ
    - "_index"                           # ç´¢å¼•åç§°

    kibana_base_url: "http://k8s-kibana.linuxtian.com/app/kibana"

    feishu_card_template:
      msg_type: interactive
      card:
        header:
          title:
            tag: plain_text
            content: "ğŸš¨ k8sä¸šåŠ¡errorå¼‚å¸¸å‘Šè­¦"
          template: red
        elements:
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ•’ è§¦å‘æ—¶é—´ï¼š**{{@timestamp_local}}" # æœ¬åœ°æ—¶é—´ UTC+8
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“¦ å‘½åç©ºé—´ï¼š**{{kubernetes_namespace_name}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ³ Pod åç§°ï¼š**{{kubernetes_pod_name}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ§ª å®¹å™¨é•œåƒï¼š**{{kubernetes_container_image}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“› å®¹å™¨åç§°ï¼š**{{kubernetes_container_name}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“ˆ æ—¥å¿—æµï¼š**{{stream}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ—‚ ç´¢å¼•åç§°ï¼š**{{_index}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“Š é”™è¯¯æ•°é‡ï¼š**{{num_hits}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ¯ è§„åˆ™å‘½ä¸­æ•°ï¼š**{{num_matches}}"
          - tag: div
            text:
              tag: lark_md
              content: "**ğŸ“ é”™è¯¯æ—¥å¿—ï¼š**{{message}}"
          - tag: hr
          - tag: action
            actions:
              - tag: button
                text:
                  tag: plain_text
                  content: "ğŸ” æŸ¥çœ‹ Kibana æ—¥å¿—"
                type: default
                url: "{{ kibana_url }}"

  config.json: |
    {
      "appName": "elastalert-server",
      "port": 3030,                
      "wsport": 3333,
      "elastalertPath": "/opt/elastalert",
      "verbose": false,
      "es_debug": false,
      "debug": false,
      "rulesPath": {
        "relative": true,
        "path": "/rules"
      },
      "templatesPath": {
        "relative": true,
        "path": "/rule_templates"
      },
      "es_host": "elasticsearch",
      "es_port": 9200,
      "writeback_index": "elastalert_status"
    }
  # ElastAlertä¸»é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†è§„åˆ™ç›®å½•ã€æ‰§è¡Œé¢‘ç‡ç­‰å…¨å±€è®¾ç½®
  elastalert.yaml: |
    rules_folder: rules               # è§„åˆ™ç›®å½•
    run_every:
      seconds: 60                     # æ¯ 60 ç§’æ£€æŸ¥ä¸€æ¬¡è§„åˆ™
    buffer_time:
      minutes: 5                      # ç¼“å†²æ—¶é—´ä¸º 5 åˆ†é’Ÿ
    max_running_instances: 5          # å…è®¸æœ€å¤šå¹¶å‘ 5 ä¸ªè§„åˆ™æ‰§è¡Œ
    es_host: elasticsearch            # Elasticsearch ä¸»æœº
    es_port: 9200                     # Elasticsearch ç«¯å£
    use_ssl: False                    # æ˜¯å¦ä½¿ç”¨ SSL åŠ å¯†
    verify_certs: False               # æ˜¯å¦éªŒè¯ SSL è¯ä¹¦
    writeback_index: elastalert_status_k8s  # ç”¨äºå†™å›å‘Šè­¦çŠ¶æ€çš„ç´¢å¼•
    writeback_alias: elastalert_alerts_k8s  # ç”¨äºå†™å›å‘Šè­¦çš„åˆ«å
    alert_time_limit:
      days: 2                         # è®°å½•å‘Šè­¦çš„æœ€å¤§æ—¶é—´èŒƒå›´ï¼Œè¶…è¿‡2å¤©çš„å‘Šè­¦ä¼šè¢«æ¸…é™¤
